## Redis源码分析


### 第一部分：基本数据结构


#### 1. 简单动态字符串（sds）

- sds.h
- sds.c
- zmalloc.h
- zmalloc.c

**1.1 简单动态字符串优势**

- 常数复杂度获取字符串长度
- 杜绝缓冲区溢出(strcat...)
- 修改字符串时减少内存重分配次数(采用预分配和惰性删除策略)
- 二进制空间安全(不会被'/0'截断)
- 兼容部分C字符串函数


#### 2. 链表

- adlist.h
- adlist.c

常规的双向链表，可以设置链表的复制、释放、比较函数。


#### 3. 字典

- dict.h
- dict.c
- fmacros.h(系统宏定义)
- redisassert.h(redis自定义的assert函数)

**3.1 哈希算法**
index := hash_fn(key); (fn采用MurmurHash2算法)
index := index & mask; (mask为hash表桶大小减1)

**3.2 渐进式 rehash**

**3.2.1 时机**

- 扩张：未处于落盘期间负载因子大于等于1的时候；处于落盘期间负载因子大于等于5的时候。
- 收缩：负载因子小于0.1的时候。

**3.2.2 渐进机制**

1.  将rehashidx标志置位0，表示开始迁移。
2.  置位后的每个查询、写入、删除操作之前，都先进行一段时间(1ms)数据迁移。
3.  迁移期间数据的变动全部作用于备表，查询时先查主，再查备。
4.  迁移成功后用备表替换主表，重置备表，将rehashidx置位-1。


#### 4. 跳跃表

- redis.h
- t_zset.c
- config.h(系统配置变量)
- solarisfixes.h(针对sun系统的一些宏定义)
- version.h(版本号文件)
- help.h(命令信息集合)

常规跳表实现，注意跳表是有序的。redis的跳表最多32层，按照score来排序，当分值相同时，则根据存储对象的大小来比较排序。
